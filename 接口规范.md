# ChatBox 接口规范 (chatbox.json)

## 概述

`chatbox.json` 是用于配置 AI 对话界面工具栏的接口，包含两类工具：

- `builtin_tools`: 显示在输入框左侧的常驻工具按钮（推荐 3 个以内）
- `extra_tools`: 通过 "+" 按钮弹出的扩展菜单项（支持多种类型）

## 接口结构

```json
{
  "builtin_tools": [
    // 内置工具按钮配置
  ],
  "extra_tools": [
    // 扩展菜单项配置
  ]
}
```

---

## 1. builtin_tools 配置

显示在输入框左侧的常驻工具按钮，**推荐不超过 3 个**（超过 3 个可能导致排版错乱），可空

### 按钮配置项

| 字段       | 类型     | 必填 | 说明                               |
|----------|--------|----|----------------------------------|
| name     | string | 是  | 按钮唯一标识，在发送请求时会携带此标识用于标记是否启用      |
| text     | string | 是  | 按钮显示的名称                          |
| iconType | string | 是  | 图标类型，可选值：`library`、`svg`、`image` |
| iconData | string | 是  | 图标数据，根据 iconType 不同有不同含义         |
| bgColor  | string | 否  | 按钮背景颜色，默认 `#4F39F6`              |
| isActive | bool   | 否  | 是否默认激活                           |
| disabled  | bool   | 否  | 是否禁用                             |

### iconType 说明

#### 1. library (图标库)

使用 React Icons 库中的图标，目前支持：

- `search` → FaSearch
- `refresh` → FaRedo
- `earth` → FaEarthAmericas

```json
{
  "name": "search",
  "text": "搜索",
  "iconType": "library",
  "iconData": "search",
  "bgColor": "#4F39F6"
}
```

#### 2. svg (内联 SVG)

直接提供 SVG 代码字符串（有基础过滤，避免 XSS）：

```json
{
  "name": "custom",
  "text": "自定义",
  "iconType": "svg",
  "iconData": "<svg viewBox='0 0 24 24' fill='currentColor'><path d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8h4z'/></svg>",
  "bgColor": "#FF6B6B"
}
```

#### 3. image (图片)

提供图片 URL 地址，推荐 1:1 比例：

```json
{
  "name": "avatar",
  "text": "头像",
  "iconType": "image",
  "iconData": "https://example.com/avatar.png",
  "bgColor": "#4ECDC4"
}
```

---

## 2. extra_tools 配置

通过 "+" 按钮弹出的扩展菜单，支持多种类型菜单项，可空

### 菜单项通用结构

所有菜单项必须包含 `type` 字段，其他字段根据类型不同有所差异。

```json
{
  "type": "toggle",
  // 菜单类型
  "name": "autoTranslate",
  // 唯一标识（非 label/separator 类型必需）
  "text": "自动翻译",
  // 显示文本
  "iconType": "library",
  // 图标类型（可选）
  "iconData": "earth"
  // 图标数据（可选）
}
```

### 支持的菜单类型

#### 1. toggle (按钮型)

- **功能**：点击一次选中，点击一次取消选择
- **状态存储**：布尔值 (`true`/`false`)
- **状态路径**：`toolsStatus.extra_tools[name]`
- **必需字段**：`name`, `text`

```json
{
  "type": "toggle",
  "name": "autoTranslate",
  "text": "自动翻译",
  "iconType": "library",
  "iconData": "earth"
}
```

#### 2. radio (单选型)

- **功能**：组内单选，只能选择一项
- **状态存储**：选中项的 `name` 字符串
- **状态路径**：`toolsStatus.extra_tools[name]`
- **必需字段**：`name`, `text`, `children` (至少一个选项)

```json
{
  "type": "radio",
  "name": "language",
  "text": "语言设置",
  "iconType": "library",
  "iconData": "earth",
  "children": [
    {
      "name": "zh",
      "text": "中文",
      "iconType": "image",
      "iconData": "/flags/cn.svg"
    },
    {
      "name": "en",
      "text": "English",
      "iconType": "image",
      "iconData": "/flags/us.svg"
    }
  ]
}
```

#### 3. label (标记型)

- **功能**：仅作为标题显示，无交互
- **状态存储**：无
- **必需字段**：`text`

```json
{
  "type": "label",
  "text": "高级设置"
}
```

#### 4. separator (分隔线)

- **功能**：菜单项之间的分隔线
- **状态存储**：无
- **必需字段**：无

```json
{
  "type": "separator"
}
```

#### 5. group (分组型)

- **功能**：创建嵌套子菜单
- **状态存储**：子菜单项的状态
- **必需字段**：`text`, `children` (至少一个子项)

```json
{
  "type": "group",
  "text": "主题设置",
  "children": [
    {
      "type": "radio",
      "name": "theme",
      "text": "主题模式",
      "children": [
        {
          "name": "light",
          "text": "浅色模式",
          "iconType": "svg",
          "iconData": "<svg>...</svg>"
        },
        {
          "name": "dark",
          "text": "深色模式",
          "iconType": "svg",
          "iconData": "<svg>...</svg>"
        }
      ]
    },
    {
      "type": "toggle",
      "name": "highContrast",
      "text": "高对比度"
    }
  ]
}
```

### 嵌套规则

- `group` 类型可以包含任何类型的菜单项
- `radio` 类型必须包含 `children`，且子项只能是普通菜单项（不能是 group/label/separator）
- `group` 可以嵌套多层，但建议不超过 3 层以保证用户体验

---

## 3. 状态结构说明

工具状态通过 `toolsStatus` 对象传递，结构如下：

```js
toolsStatus = {
    // 内置工具状态（布尔值）
    builtin_tools: {
        search: true,
        refresh: false,
        // ...其他内置工具
    },

    // 扩展工具状态
    extra_tools: {
        // toggle 类型：布尔值
        autoTranslate: true,

        // radio 类型：选中项的 name
        language: "zh",

        // 嵌套在 group 中的 radio 类型
        theme: "dark",

        // 嵌套在 group 中的 toggle 类型
        highContrast: false
    }
}
```

### 状态初始化规则

1. **toggle 类型**：默认 `false`
2. **radio 类型**：默认选中第一个选项
3. **group 类型**：不直接存储状态，其状态由子项决定

---

## 4. 完整示例

```json
{
  "builtin_tools": [
    {
      "name": "search",
      "text": "搜索",
      "iconType": "library",
      "iconData": "search",
      "bgColor": "#4F39F6"
    },
    {
      "name": "refresh",
      "text": "刷新",
      "iconType": "library",
      "iconData": "refresh",
      "bgColor": "#6C757D"
    },
    {
      "name": "translate",
      "text": "翻译",
      "iconType": "library",
      "iconData": "earth",
      "bgColor": "#198754"
    }
  ],
  "extra_tools": [
    {
      "type": "label",
      "text": "基础功能"
    },
    {
      "type": "toggle",
      "name": "autoTranslate",
      "text": "自动翻译",
      "iconType": "library",
      "iconData": "earth"
    },
    {
      "type": "separator"
    },
    {
      "type": "label",
      "text": "高级设置"
    },
    {
      "type": "group",
      "text": "主题设置",
      "children": [
        {
          "type": "radio",
          "name": "theme",
          "text": "主题模式",
          "children": [
            {
              "name": "light",
              "text": "浅色模式",
              "iconType": "svg",
              "iconData": "<svg viewBox='0 0 24 24' fill='currentColor'><path d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8h4z'/></svg>"
            },
            {
              "name": "dark",
              "text": "深色模式",
              "iconType": "svg",
              "iconData": "<svg viewBox='0 0 24 24' fill='currentColor'><path d='M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zm-10 5.31a4 4 0 1 1 0-8 4 4 0 0 1 0 8z'/></svg>"
            }
          ]
        },
        {
          "type": "toggle",
          "name": "highContrast",
          "text": "高对比度",
          "iconType": "image",
          "iconData": "/icons/contrast.svg"
        }
      ]
    },
    {
      "type": "radio",
      "name": "language",
      "text": "语言设置",
      "iconType": "library",
      "iconData": "earth",
      "children": [
        {
          "name": "zh",
          "text": "中文",
          "iconType": "image",
          "iconData": "/flags/cn.svg"
        },
        {
          "name": "en",
          "text": "English",
          "iconType": "image",
          "iconData": "/flags/us.svg"
        },
        {
          "name": "ja",
          "text": "日本語",
          "iconType": "image",
          "iconData": "/flags/jp.svg"
        }
      ]
    },
    {
      "type": "separator"
    },
    {
      "type": "group",
      "text": "更多设置",
      "children": [
        {
          "type": "toggle",
          "name": "notifications",
          "text": "消息通知"
        },
        {
          "type": "toggle",
          "name": "sound",
          "text": "声音提示"
        }
      ]
    }
  ]
}
```

---

## 5. 注意事项

1. **命名规范**：
    - 所有 `name` 字段必须唯一（在整个 extra_tools 范围内）
    - 建议使用小写字母和下划线命名法（如 `auto_translate`）

2. **图标规范**：
    - SVG 图标建议使用 24x24 尺寸
    - 图片图标建议使用 24x24 像素，1:1 比例
    - 所有图标应为单色（系统会自动处理颜色）

3. **菜单深度**：
    - 建议菜单嵌套不超过 3 层
    - 过深的嵌套会影响用户体验

4. **状态管理**：
    - 状态会在用户交互时自动更新
    - 通过 `onSendMessage` 回调可获取当前完整状态

5. **性能考虑**：
    - 菜单项总数建议不超过 20 个
    - 复杂的嵌套结构可能影响渲染性能

---

## 6. 状态使用示例

在父组件中获取工具状态并使用：

```jsx
function ParentComponent() {
    const [toolsStatus, setToolsStatus] = useState({
        builtin_tools: {},
        extra_tools: {}
    });

    const handleSendMessage = (message, toolsStatus) => {
        console.log('用户消息:', message);

        // 检查内置工具状态
        if (toolsStatus.builtin_tools.search) {
            console.log('用户启用了搜索功能');
        }

        // 检查扩展工具状态
        if (toolsStatus.extra_tools.autoTranslate) {
            console.log('正在自动翻译...');
        }

        // 获取当前语言设置
        const currentLang = toolsStatus.extra_tools.language;
        console.log('当前语言:', currentLang);

        // 获取主题设置
        const theme = toolsStatus.extra_tools.theme;
        const highContrast = toolsStatus.extra_tools.highContrast;
        console.log(`应用主题: ${theme}${highContrast ? ' + 高对比度' : ''}`);

        // 发送消息到后端...
    };

    return (
        <ChatBox
            messageState={[message, setMessage]}
            toolsStatusState={[toolsStatus, setToolsStatus]}
            onSendMessage={handleSendMessage}
        />
    );
}
```

通过此规范，您可以灵活配置 ChatBox 组件的工具栏，满足各种业务场景需求。

# Event 总线

event 规范：

1.event 是个字典

2.字典其中的键值包括：

- type：事件的类型(string)，分为消息事件 `message` 和 控件事件 `widget`
- target：接受事件的对象(string)，具体查看说明
- payload：对象调整的参数(object)
- markId：该事件的标记，用于区分不同场景而标记，若留空或null则直接在当前页面上执行
- id：该事件的id，一般由发出者提供，与 markId 不同的是这个ID是为该事件标记的，而 markId 是为不同会话区别的

所有事件由 Websocket 或与服务器通讯的接口触发，message 事件类型不会去到前端的广播之中，widget 事件类型会进行前端广播。

## widget 事件

### target：ChatBox

#### 获取或者设置发送按钮的状态

输入

```python
{
    "command": "SendButton-State",  # 控制发送按钮状态
    "value": ['disabled', 'normal', 'loading', 'generating']  # 任选一，如果是其他的就是默认获取按钮状态（为空也许）
}
```

返回

```python
{
    "command": "SendButton-State",  # 返回发送按钮状态
    "value": ['disabled', 'normal', 'loading', 'generating'] #  任选一
}
```

此方法忽略 markId

#### 设置输入框内容


输入

```python
{
    "command": "Set-Message",
    "value": "要设置的内容" # 内容
}
```

返回

```python
{
    "command": "Set-Message", 
    "success": true  
}
```

此方法忽略 markId

#### 获取输入框内容


输入

```python
{
    "command": "Get-Message",
}
```

返回

```python
{
    "command": "Set-Message", 
    "value": "内容"  
}
```

此方法忽略 markId


#### 设置聊天输入框属性

输入

```python
{
    "command": "Setup-ChatBox",
    "value“: object  # 参见 ChatBox 接口规范
}
```

返回

```python
{
    "command": "Setup-ChatBox", 
    "success": true 
}
``` 