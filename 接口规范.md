# 服务器响应规范

```json
{
    "success": true,
    "code": 200,
    "msg": "请求成功",
    "data": null  // 主要内容载体
}
```

# ChatBox 接口规范 (CHATBOX_ENDPOINT)

## 概述

用于配置 AI 对话界面工具栏的接口，包含两类工具，内容写在 data 字段中：

- `builtin_tools`: 显示在输入框左侧的常驻工具按钮（推荐 3 个以内）
- `extra_tools`: 通过 "+" 按钮弹出的扩展菜单项（支持多种类型）

## 接口结构

```json
{
  "builtin_tools": [
    // 内置工具按钮配置
  ],
  "extra_tools": [
    // 扩展菜单项配置
  ],
  "readOnly": true,  // 是否只读
  "tipMessage": "text or null",  // 输入框上面的提示，默认一直不消失
  "tipMessageFadeOutDelay": null,  // 传入一个毫秒级的数字，如果没有该项或者为 null 则为一直不消失
  "ignoreAttachmentTools": false,  // 是否提供附件上传功能
}
```

---

## 1. builtin_tools 配置

显示在输入框左侧的常驻工具按钮，**推荐不超过 3 个**（超过 3 个可能导致排版错乱），可空

### 按钮配置项

| 字段       | 类型     | 必填 | 说明                               |
|----------|--------|----|----------------------------------|
| name     | string | 是  | 按钮唯一标识，在发送请求时会携带此标识用于标记是否启用      |
| text     | string | 是  | 按钮显示的名称                          |
| iconType | string | 是  | 图标类型，可选值：`library`、`svg`、`image` |
| iconData | string | 是  | 图标数据，根据 iconType 不同有不同含义         |
| bgColor  | string | 否  | 按钮背景颜色，默认 `#4F39F6`              |
| isActive | bool   | 否  | 是否默认激活                           |
| disabled  | bool   | 否  | 是否禁用                             |

### iconType 说明

#### 1. library (图标库)

使用 React Icons 库中的图标，目前支持：

- `search` → FaSearch
- `refresh` → FaRedo
- `earth` → FaEarthAmericas

```json
{
  "name": "search",
  "text": "搜索",
  "iconType": "library",
  "iconData": "search",
  "bgColor": "#4F39F6"
}
```

#### 2. svg (内联 SVG)

直接提供 SVG 代码字符串（有基础过滤，避免 XSS）：

```json
{
  "name": "custom",
  "text": "自定义",
  "iconType": "svg",
  "iconData": "<svg viewBox='0 0 24 24' fill='currentColor'><path d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8h4z'/></svg>",
  "bgColor": "#FF6B6B"
}
```

#### 3. image (图片)

提供图片 URL 地址，推荐 1:1 比例：

```json
{
  "name": "avatar",
  "text": "头像",
  "iconType": "image",
  "iconData": "https://example.com/avatar.png",
  "bgColor": "#4ECDC4"
}
```

---

## 2. extra_tools 配置

通过 "+" 按钮弹出的扩展菜单，支持多种类型菜单项，可空

### 菜单项通用结构

所有菜单项必须包含 `type` 字段，其他字段根据类型不同有所差异。

```json
{
  "type": "toggle",
  // 菜单类型
  "name": "autoTranslate",
  // 唯一标识（非 label/separator 类型必需）
  "text": "自动翻译",
  // 显示文本
  "iconType": "library",
  // 图标类型（可选）
  "iconData": "earth"
  // 图标数据（可选）
  "disabled": true,
  // 是否禁用
  "default": true,  // toggle 支持，radio在父菜单使用
  "autoClose": false // 默认 false，是否点击完自动关闭
}
```

### 支持的菜单类型

#### 1. toggle (按钮型)

- **功能**：点击一次选中，点击一次取消选择
- **状态存储**：布尔值 (`true`/`false`)
- **状态路径**：`toolsStatus.extra_tools[name]`
- **必需字段**：`name`, `text`

```json
{
  "type": "toggle",
  "name": "autoTranslate",
  "text": "自动翻译",
  "iconType": "library",
  "iconData": "earth"
}
```

#### 2. radio (单选型)

- **功能**：组内单选，只能选择一项
- **状态存储**：选中项的 `name` 字符串
- **状态路径**：`toolsStatus.extra_tools[name]`
- **必需字段**：`name`, `text`, `children` (至少一个选项)

```json
{
  "type": "radio",
  "name": "language",
  "text": "语言设置",
  "iconType": "library",
  "iconData": "earth",
  "default": "en",  // 是否默认选中
  "children": [
    {
      "name": "zh",
      "text": "中文",
      "iconType": "image",
      "iconData": "/flags/cn.svg"
    },
    {
      "name": "en",
      "text": "English",
      "iconType": "image",
      "iconData": "/flags/us.svg",
    }
  ]
}
```

#### 3. label (标记型)

- **功能**：仅作为标题显示，无交互
- **状态存储**：无
- **必需字段**：`text`

```json
{
  "type": "label",
  "text": "高级设置"
}
```

#### 4. separator (分隔线)

- **功能**：菜单项之间的分隔线
- **状态存储**：无
- **必需字段**：无

```json
{
  "type": "separator"
}
```

#### 5. group (分组型)

- **功能**：创建嵌套子菜单，最终输出时会嵌套输出工具
- **状态存储**：子菜单项的状态
- **必需字段**：`text`, `children`, `name` (至少一个子项)

```json
{
  "type": "group",
  "text": "主题设置",
  "children": [
    {
      "type": "radio",
      "name": "theme",
      "text": "主题模式",
      "children": [
        {
          "name": "light",
          "text": "浅色模式",
          "iconType": "svg",
          "iconData": "<svg>...</svg>"
        },
        {
          "name": "dark",
          "text": "深色模式",
          "iconType": "svg",
          "iconData": "<svg>...</svg>"
        }
      ]
    },
    {
      "type": "toggle",
      "name": "highContrast",
      "text": "高对比度"
    }
  ]
}
```

### 嵌套规则

- `group` 类型可以包含任何类型的菜单项
- `radio` 类型必须包含 `children`，且子项只能是普通菜单项（不能是 group/label/separator）
- `group` 可以嵌套多层，但建议不超过 3 层以保证用户体验

---

## 3. 状态结构说明

工具状态通过 `toolsStatus` 对象传递，结构如下：

```js
toolsStatus = {
    // 内置工具状态（布尔值）
    builtin_tools: {
        search: true,
        refresh: false,
        // ...其他内置工具
    },

    // 扩展工具状态
    extra_tools: {
        // toggle 类型：布尔值
        autoTranslate: true,

        // radio 类型：选中项的 name
        language: "zh",

        // 嵌套在 group 中的 radio 类型
        theme: "dark",

        // 嵌套在 group 中的 toggle 类型
        highContrast: false
    }
}
```

### 状态初始化规则

1. **toggle 类型**：默认 `false`
2. **radio 类型**：默认选中第一个选项
3. **group 类型**：不直接存储状态，其状态由子项决定

---

## 4. 完整示例

```json
{
  "builtin_tools": [
    {
      "name": "search",
      "text": "搜索",
      "iconType": "library",
      "iconData": "search",
      "bgColor": "#4F39F6"
    },
    {
      "name": "refresh",
      "text": "刷新",
      "iconType": "library",
      "iconData": "refresh",
      "bgColor": "#6C757D"
    },
    {
      "name": "translate",
      "text": "翻译",
      "iconType": "library",
      "iconData": "earth",
      "bgColor": "#198754"
    }
  ],
  "extra_tools": [
    {
      "type": "label",
      "text": "基础功能"
    },
    {
      "type": "toggle",
      "name": "autoTranslate",
      "text": "自动翻译",
      "iconType": "library",
      "iconData": "earth"
    },
    {
      "type": "separator"
    },
    {
      "type": "label",
      "text": "高级设置"
    },
    {
      "type": "group",
      "text": "主题设置",
      "children": [
        {
          "type": "radio",
          "name": "theme",
          "text": "主题模式",
          "children": [
            {
              "name": "light",
              "text": "浅色模式",
              "iconType": "svg",
              "iconData": "<svg viewBox='0 0 24 24' fill='currentColor'><path d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8h4z'/></svg>"
            },
            {
              "name": "dark",
              "text": "深色模式",
              "iconType": "svg",
              "iconData": "<svg viewBox='0 0 24 24' fill='currentColor'><path d='M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zm-10 5.31a4 4 0 1 1 0-8 4 4 0 0 1 0 8z'/></svg>"
            }
          ]
        },
        {
          "type": "toggle",
          "name": "highContrast",
          "text": "高对比度",
          "iconType": "image",
          "iconData": "/icons/contrast.svg"
        }
      ]
    },
    {
      "type": "radio",
      "name": "language",
      "text": "语言设置",
      "iconType": "library",
      "iconData": "earth",
      "children": [
        {
          "name": "zh",
          "text": "中文",
          "iconType": "image",
          "iconData": "/flags/cn.svg"
        },
        {
          "name": "en",
          "text": "English",
          "iconType": "image",
          "iconData": "/flags/us.svg"
        },
        {
          "name": "ja",
          "text": "日本語",
          "iconType": "image",
          "iconData": "/flags/jp.svg"
        }
      ]
    },
    {
      "type": "separator"
    },
    {
      "type": "group",
      "text": "更多设置",
      "children": [
        {
          "type": "toggle",
          "name": "notifications",
          "text": "消息通知"
        },
        {
          "type": "toggle",
          "name": "sound",
          "text": "声音提示"
        }
      ]
    }
  ]
}
```

---

## 5. 注意事项

1. **命名规范**：
    - 所有 `name` 字段必须唯一（在整个 extra_tools 范围内）
    - 建议使用小写字母和下划线命名法（如 `auto_translate`）

2. **图标规范**：
    - SVG 图标建议使用 24x24 尺寸
    - 图片图标建议使用 24x24 像素，1:1 比例
    - 所有图标应为单色（系统会自动处理颜色）

3. **菜单深度**：
    - 建议菜单嵌套不超过 3 层
    - 过深的嵌套会影响用户体验

4. **状态管理**：
    - 状态会在用户交互时自动更新
    - 通过 `onSendMessage` 回调可获取当前完整状态

5. **性能考虑**：
    - 菜单项总数建议不超过 20 个
    - 复杂的嵌套结构可能影响渲染性能

---

## 6. 状态使用示例

在父组件中获取工具状态并使用：

```jsx
function ParentComponent() {
    const [toolsStatus, setToolsStatus] = useState({
        builtin_tools: {},
        extra_tools: {}
    });

    const handleSendMessage = (message, toolsStatus) => {
        console.log('用户消息:', message);

        // 检查内置工具状态
        if (toolsStatus.builtin_tools.search) {
            console.log('用户启用了搜索功能');
        }

        // 检查扩展工具状态
        if (toolsStatus.extra_tools.autoTranslate) {
            console.log('正在自动翻译...');
        }

        // 获取当前语言设置
        const currentLang = toolsStatus.extra_tools.language;
        console.log('当前语言:', currentLang);

        // 获取主题设置
        const theme = toolsStatus.extra_tools.theme;
        const highContrast = toolsStatus.extra_tools.highContrast;
        console.log(`应用主题: ${theme}${highContrast ? ' + 高对比度' : ''}`);

        // 发送消息到后端...
    };

    return (
        <ChatBox
            messageState={[message, setMessage]}
            toolsStatusState={[toolsStatus, setToolsStatus]}
            onSendMessage={handleSendMessage}
        />
    );
}
```

通过此规范，您可以灵活配置 ChatBox 组件的工具栏，满足各种业务场景需求。

# Event 总线

event 规范：

1.event 是个字典

2.字典其中的键值包括：

- type：事件的类型(string)，分为消息事件 `message` 、 控件事件 `widget` 、 页面事件 `page` 和 Websocket 事件 `websocket`，回复不携带
- target：接受事件的对象(string)，具体查看说明，回复不携带
- payload：对象调整的参数(object)
- markId：该事件的标记，用于区分不同场景而标记，若留空或null则直接在当前页面上执行，如果不提供 markId 默认是在所有页面上广播的，回复不携带
- id：该事件的id，一般由发出者提供，与 markId 不同的是这个ID是为该事件标记的，而 markId 是为不同会话区别的。
- isReply：是否属于回复事件
- fromWebsocket：标记事件是否从 websocket 来的，如果是就不发送

所有事件由 Websocket 或与服务器通讯的接口触发，message 事件类型不会去到前端的广播之中，widget 事件类型会进行前端广播。
websocket 事件不会被发送到服务器

websocker 事件参考

```javascript
{
    type: "websocket",
    target: "onclose",  // onerror onopen onclose
    payload: null,
    isReply: false
}
``·

## widget 事件

### target：ChatBox

#### 获取或者设置发送按钮的状态

输入

```python
{
    "command": "SendButton-State",  # 控制发送按钮状态
    "value": ['disabled', 'normal', 'loading', 'generating']  # 任选一，如果是其他的就是默认获取按钮状态（为空也许）
}
```

返回

```python
{
    "command": "SendButton-State",  # 返回发送按钮状态
    "value": ['disabled', 'normal', 'loading', 'generating'] #  任选一
}
```



#### 设置输入框内容


输入

```python
{
    "command": "Set-Message",
    "value": "要设置的内容" # 内容
}
```




#### 获取输入框内容


输入

```python
{
    "command": "Get-Message",
}
```

返回

```python
{
    "command": "Set-Message", 
    "value": "内容"  
}
```




#### 设置聊天输入框属性

输入

```python
{
    "command": "Setup-ChatBox",
    "value“: object  # 参见 ChatBox 接口规范
}
```


#### 设置备选项目

输入

```python
{
    "command": "Set-QuickOptions",
    "value": [{id: 1, label: "今天天气怎么样？", value: "今天天气怎么样？"}, ...]
}
```


#### 设置/获取附件数据

输入

```python
{
    "command": "Attachment-Meta",
    "value": [{附件格式数据}, ...]  # 不加或者留空返回附件数据
}
```

返回

```python
{
    "command": "Attachment-Meta", 
    "value": []   # 附件数据
}
```

#### 设置是否处于编辑模式

输入，当用户进行消息编辑时，这个事件会自动触发，markId 在外边标记了

```python
{
    "command": "Set-EditMessage",
    "isEdit": true/false,  // 是否编辑模式
    "attachments": []  // 附件数据
    "content": ""  // 输入框文本
    "msgId": ""  // 目标消息ID
}
```

返回

```python
{
    "command": "Set-EditMessage", 
    "success": true
}
```

### target：ChatPage

#### 设置消息变为加载

真正的执行者在 MessageContainer ，这个操作会使从提供ID的消息下方（包括该消息）用加载元素占位

```javascript
{
    "command": "Set-SwitchingMessage",
    "value": "msgId"
}
```


返回

```python
{
    "command": "Set-SwitchingMessage", 
    "success": true
}
```

## 附件格式参考

```js
{
    preview: '/src/assets/test.png',
    previewType: 'image',
    name: '示例图片.jpg',
    size: 2048000,
    serverId: 'img_67890',
    downloadUrl: 'https://example.com/images/img_67890'
}
```

# Markdown 额外语法

```
:::card{type=processing id=123}
content
:::
```

id 用于确保在前端可以正常展开卡片，一定要传入 id

语言名称：card{type=processing}
用于展示加载卡片，，当单独一行为 `[DONE]` 时，表示处理完成，加载卡片会把最新的一行展示在卡片上。

语言名称：card{type=thinking}
用于展示思考卡片，当单独一行为 `[DONE]` 时，表示思考完成。

语言名称：card{type=invisible}
里面的内容全部隐藏

# ChatPage 逻辑

## 获取 markId

如果没有 markId 就向服务器请求生成内容，请求时随机生成一个唯一uuid字符串（markId）并发送给服务器，负载如下：

```javascript
{
    type: "page", 
    target: "ChatPage",
    payload: {
        command: "Get-MarkId"
    },
    id: "3e4f8a1b-5c9d-4e2a-8f1a-7b3c9d2e4f5a",  // 本地随机字串
    isReply: false
}
```

回复：

```javascript
{
    payload: {
        success: true,  // 如果为 True 就是获取成功, False 则是失败，提示下面的 value
        value: "566f8a77-3c9d-112a-8b1a-2453c92e434b" // 服务器正式 markid
    }, 
    id: "3e4f8a1b-5c9d-4e2a-8f1a-7b3c9d2e4f5a",
    isReply: true
}
```

这样做的好处是让服务器决定存储在数据库的名称而不是前端

# message 事件类型

## 添加一个完整的 message 消息

添加消息不会使页面中的消息展示增加，需要另外设置消息顺序

```javascript
{
    type: "message",
    target: "ChatPage",
    payload: {
        command: "Add-Message",
        value: {
            "ID": {
                position: 'right', 
                    content: '这是一个普通段落。\n' +
                '\n\n' +
                ':::card{type=processing id=123}\n' +
                '正在加载用户数据，请稍候...\nasdad\n\n正在上网搜索资料\n[DONE]\n:::\n\n122',
                    name: 'AI Assistant',
                    avatar: '/src/assets/AI.png'
            }
        }
    }
}
```

回复：

```javascript
{ 
    success: true 
}
```

## 设置消息顺序

消息被添加必须设置消息链才可显示到界面上

```javascript
{
    type: "message",
    target: "ChatPage",
    payload: {
    command: "MessagesOrder-Meta",
        value: ["c6113dac-22c4-4a54-a1f1-957022fbde71"]  // 如果不提供，则不修改消息链
    }
}
```

回复：

```javascript
{ 
    value: ["c6113dac-22c4-4a54-a1f1-957022fbde71"] 
}
```


## 追加消息内容

模型生成文字的场景是非常常见的，不断设置 Message 会有效率问题，所以考虑追加内容。

```javascript
{
    type: "message",
    target: "ChatPage",
    payload: {
    command: "Add-MessageContent",
        value: {"02fa133e-e7d0-4bb0-89e2-b35656b442e9": "测试"},  // 消息ID：要追加内容
        reply: true // 默认为 falsem，如果为 True 则会触发响应是否成功
    }
}
```

回复：

```javascript
{ 
    success: true
}
```

## 响应历史消息加载完成

由前端发出，表示历史消息已经加载完成，当 ws 重连并且已经加载历史对话界面时也会触发

```javascript
{
    type: "message",
    target: "ChatPage",
    payload: {
        command: "Messages-Loaded",
    }
    markId: "xxx"
}
```

响应不需要回复

## 当用户发送消息

由前端发出

```javascript
{
    type: "message",
    target: "ChatPage",
    payload: {
        "command": "Message-Send",
        "message": "Text",
        "toolsStatus": {
            "builtin_tools": {
                "search": false
            },
            "extra_tools": {
                "autoTranslate": false
            }
        },
        "attachments": [], 
        "immediate": true,  // 是否立即发送，重生成消息依赖于此
        "isEdit": true  // 是否为编辑消息模式
        "msgId": ""  // 如果为编辑消息模式才会附带
    },
    markId: "xxx"
}
```




## 切换分支事件

由前端发出，

```javascript
{
    type: "message",
    target: "ChatPage",
    payload: {
        command: "Switch-Message", 
        msgId: "ID", 
        nextMessage: "ID"    
    }
}
```

- msgId 目前的消息ID
- nextMessage 下一条对话的ID

后端要判断 nextMessage 是否在 messages 内，无 data 字段响应


## 消息格式


```javascript
{
    prevMessage: 'ID0',  // 上一条对话的ID，如果没有是 null
    position: 'left',   // 属于左边还是右边(right)，右边默认为气泡，还有一个 null 如果为空或者没有就是隐藏消息，隐藏消息不会被渲染
    content: '',  // 内容
    name: 'AI Assistant',  // 昵称
    avatar: '/src/assets/AI.png',  // 头像
    messages: ['ID1', 'ID2', 'ID3'],  // 如果没有是空列表
    nextMessage: 'ID1',  // 目前选择的 下一条对话的ID，如果没有是 null
    attachments: [],   // 附件内容，可选
    allowRegenerate: true,  // 是否允许重新生成，默认为 true，可选
    tip: ""  // 如果存在，下方将会显示一个信息提示，可选
}
```

# 上传接口 UPLOAD_ENDPOINT


前端默认 POST 表单的 file 字段

服务器应该返回 "附件格式参考" 部分的内容


# 消息获取接口 CHAT_MESSAGES_ENDPOINT

前端默认 GET，提供表单：

- markId 目前的对话ID
- prevId 目前最早的一条消息的ID，如果没有提供则目前没有消息（可选，默认）
- nextId 前端没有的消息Id，要向后端请求 nextId 消息以及其之后的所有消息（可选）

后端提供的数据字段：

```javascript
{
    "messages": {
        "test1": {
            'position': 'left',
                'name': 'Pikachu',
                'content': '测试',
                'avatar': '/src/assets/human.jpg'
        }
    },  # 所有对话元数据 ID:消息内容 完整元数据请参考消息源数据格式
    "messagesOrder": ['test1'],  # 之前的对话顺序，不包含 prevId
    "haveMore": True  # 是否还有数据没有被加载，如果只有 nextId 这个选项是不提供的
}
```

# 默认前端 LocalStorage 配置

- SyncMessageSwitch 布尔值，是否实时同步消息选择分支给前端，如果为真每次切换分支时都会发送一个事件给服务器


# 全局上下文事件

全局上下文默认接受所有 markid 的事件

## 发送吐司消息

```javascript
{
    type: "widget",
    target: "Context",
    payload: {
        command: "Show-Toast",
        name: "error",  // 吐司类型查看 sonner
        args: "错误"  // 如果是一个列表则传递参数，否则就默认把其当成第一个参数传递
    }
}
```